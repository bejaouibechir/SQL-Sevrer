# **Exercices sur Policy-Based Management (PBM)**

Policy-Based Management (PBM) est un outil puissant pour gérer SQL Server en définissant des règles (policies) et en vérifiant leur conformité. Voici une série d’exercices pour découvrir PBM avec des cas où les effets sont **immédiatement observables**.

---

### **Préparation : Activer Policy-Based Management**
1. Activez l’option PBM dans SQL Server Management Studio (SSMS) si ce n’est pas déjà fait.
2. Dans SSMS, naviguez vers **Management > Policy Management > Policies**.

---

### **Exercice 1 : Vérifier que toutes les bases utilisent le mode de récupération SIMPLE**
1. **Objectif** : Créer une policy pour vérifier que toutes les bases ont le mode de récupération `SIMPLE`.
2. **Étapes** :
   - **Créer une condition** :
     1. Allez dans **Management > Policy Management > Conditions**.
     2. Créez une condition nommée `SimpleRecoveryMode`.
     3. **Facette** : `Database Options`.
     4. **Expression** : `@RecoveryModel = 'Simple'`.
   - **Créer une policy** :
     1. Allez dans **Management > Policy Management > Policies**.
     2. Créez une policy nommée `EnforceSimpleRecoveryMode`.
     3. Associez la condition `SimpleRecoveryMode`.
     4. Définissez le mode d’évaluation sur `On Demand` ou `On Schedule`.
   - **Vérifiez la conformité** :
     1. Faites un clic droit sur la policy et choisissez **Evaluate**.
     2. Les bases non conformes apparaîtront immédiatement.
3. **Résultat attendu** : Les bases en mode `FULL` ou `BULK_LOGGED` sont signalées.

---

### **Exercice 2 : Empêcher la création de bases avec un nom interdit**
1. **Objectif** : Bloquer la création de bases dont le nom contient des mots interdits (ex. `temp`, `test`).
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Database`.
     2. **Expression** : `NOT LIKE(@Name, '%temp%') AND NOT LIKE(@Name, '%test%')`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `PreventBadDatabaseNames`.
     2. Définissez le mode d’évaluation sur `On Change: Prevent`.
   - **Testez la conformité** :
     1. Essayez de créer une base non conforme :
        ```sql
        CREATE DATABASE tempTestDB;
        ```
     2. Le serveur SQL rejettera la création.
3. **Résultat attendu** : La création est bloquée avec un message d’erreur.

---

### **Exercice 3 : Vérifier que les noms de table respectent un format spécifique**
1. **Objectif** : Imposer un préfixe `tbl_` pour tous les noms de tables.
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Table`.
     2. **Expression** : `LIKE(@Name, 'tbl_%')`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `EnforceTableNamePrefix`.
     2. Mode d’évaluation : `On Demand`.
   - **Testez la conformité** :
     1. Évaluez la policy sur la base cible.
     2. Les tables non conformes apparaîtront.
3. **Résultat attendu** : Une liste des tables sans le préfixe `tbl_`.

---

### **Exercice 4 : Vérifier que les index sont reconstruits régulièrement**
1. **Objectif** : Vérifier que les index fragmentés au-delà de 30% sont reconstruits.
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Index`.
     2. **Expression** : `@Fragmentation < 30`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `CheckIndexFragmentation`.
     2. Mode d’évaluation : `On Demand`.
   - **Testez la conformité** :
     1. Évaluez la policy.
     2. Les index non conformes apparaîtront immédiatement.
3. **Résultat attendu** : Les index fragmentés au-delà de 30% sont signalés.

---

### **Exercice 5 : Empêcher la modification des bases système**
1. **Objectif** : Interdire toute modification sur les bases système.
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Database`.
     2. **Expression** : `@IsSystemObject = False`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `PreventSystemDatabaseChanges`.
     2. Mode d’évaluation : `On Change: Prevent`.
   - **Testez la conformité** :
     1. Essayez de modifier une base système :
        ```sql
        ALTER DATABASE master SET SINGLE_USER;
        ```
     2. La modification sera bloquée.
3. **Résultat attendu** : Les bases système sont protégées.

---

### **Exercice 6 : Empêcher l’utilisation d’un certain type de données**
1. **Objectif** : Bloquer la création de colonnes utilisant le type `TEXT`.
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Column`.
     2. **Expression** : `@DataType NOT IN ('text', 'ntext', 'image')`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `PreventDeprecatedDataTypes`.
     2. Mode d’évaluation : `On Change: Prevent`.
   - **Testez la conformité** :
     1. Essayez de créer une colonne avec un type interdit :
        ```sql
        CREATE TABLE TestTable (Col1 TEXT);
        ```
     2. La création sera bloquée.
3. **Résultat attendu** : Le serveur rejette les types obsolètes.

---

### **Exercice 7 : Vérifier la présence de contraintes PRIMARY KEY**
1. **Objectif** : S’assurer que toutes les tables ont une clé primaire.
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Table`.
     2. **Expression** : `@HasPrimaryKey = True`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `EnforcePrimaryKey`.
     2. Mode d’évaluation : `On Demand`.
   - **Testez la conformité** :
     1. Évaluez la policy sur une base avec des tables sans clé primaire.
3. **Résultat attendu** : Les tables sans clé primaire sont listées.

---

### **Exercice 8 : Vérifier que les bases utilisent le même collation**
1. **Objectif** : Vérifier que toutes les bases utilisent une collation spécifique.
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Database Options`.
     2. **Expression** : `@Collation = 'SQL_Latin1_General_CP1_CI_AS'`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `EnforceDatabaseCollation`.
     2. Mode d’évaluation : `On Demand`.
   - **Testez la conformité** :
     1. Évaluez la policy.
3. **Résultat attendu** : Les bases non conformes apparaîtront.

---

### **Exercice 9 : Empêcher les comptes sans expiration de mot de passe**
1. **Objectif** : Bloquer les comptes SQL avec un mot de passe sans expiration.
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Login`.
     2. **Expression** : `@MustChangePassword = True`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `EnforcePasswordExpiration`.
     2. Mode d’évaluation : `On Change: Prevent`.
   - **Testez la conformité** :
     1. Essayez de créer un login non conforme :
        ```sql
        CREATE LOGIN TestLogin WITH PASSWORD = 'Test123!';
        ```
3. **Résultat attendu** : La création est bloquée si le mot de passe n’expire pas.

---

### **Exercice 10 : Vérifier la taille des bases de données**
1. **Objectif** : S’assurer qu’aucune base ne dépasse une taille définie.
2. **Étapes** :
   - **Créer une condition** :
     1. **Facette** : `Database`.
     2. **Expression** : `@Size < 500`.
   - **Créer une policy** :
     1. Associez la condition à une policy nommée `EnforceDatabaseSizeLimit`.
     2. Mode d’évaluation : `On Demand`.
   - **Testez la conformité** :
     1. Évaluez la policy.
3. **Résultat

 attendu** : Les bases non conformes sont listées.

